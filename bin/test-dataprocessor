#!/usr/bin/env php
<?php

echo "ðŸš€ Executando testes do Data Processor...\n\n";

// Detectar se estamos em um monorepo ou pacote standalone
$packageDir = __DIR__ . '/..';
$rootDir = realpath($packageDir . '/../..');

// Verificar onde estÃ¡ o vendor
if (file_exists($rootDir . '/vendor/bin/phpunit')) {
    $phpunit = $rootDir . '/vendor/bin/phpunit';
    $testsDir = $packageDir . '/tests';
    $configFile = $packageDir . '/phpunit.xml';
} elseif (file_exists($packageDir . '/vendor/bin/phpunit')) {
    $phpunit = $packageDir . '/vendor/bin/phpunit';
    $testsDir = $packageDir . '/tests';
    $configFile = $packageDir . '/phpunit.xml';
} else {
    echo "âŒ PHPUnit nÃ£o encontrado. Execute 'composer install' primeiro.\n";
    exit(1);
}

echo "ðŸ“ Usando PHPUnit: $phpunit\n";
echo "ðŸ“ Testando diretÃ³rio: $testsDir\n";
echo "ðŸ“ Config file: $configFile\n\n";

// Verificar se os testes existem
if (!is_dir($testsDir)) {
    echo "âŒ DiretÃ³rio de testes nÃ£o encontrado: $testsDir\n";
    exit(1);
}

// Testes unitÃ¡rios
if (is_dir($testsDir . '/Unit')) {
    echo "=== TESTES UNITÃRIOS ===\n";
    $cmd = "$phpunit $testsDir/Unit --configuration $configFile --colors=always";
    echo "Executando: $cmd\n";
    $return = 0;
    system($cmd, $return);

    if ($return !== 0) {
        echo "âŒ Testes unitÃ¡rios falharam!\n";
    } else {
        echo "âœ… Testes unitÃ¡rios passaram!\n";
    }
    echo "\n";
}

// Testes de feature (excluindo benchmark)
if (is_dir($testsDir . '/Feature')) {
    echo "=== TESTES DE INTEGRAÃ‡ÃƒO ===\n";
    $cmd = "$phpunit $testsDir/Feature --configuration $configFile --colors=always --exclude-group=benchmark";
    echo "Executando: $cmd\n";
    $return = 0;
    system($cmd, $return);

    if ($return !== 0) {
        echo "âŒ Testes de integraÃ§Ã£o falharam!\n";
    } else {
        echo "âœ… Testes de integraÃ§Ã£o passaram!\n";
    }
    echo "\n";
}

// Benchmark (opcional)
echo "=== BENCHMARK (opcional) ===\n";
echo "Execute: $phpunit $testsDir/Feature/BenchmarkTest.php --configuration $configFile --group=benchmark\n\n";

// Testes em paralelo (se paratest estiver disponÃ­vel)
$paratest = dirname($phpunit) . '/paratest';
if (file_exists($paratest)) {
    echo "=== TESTES EM PARALELO (disponÃ­vel) ===\n";
    echo "Execute: $paratest $testsDir/Unit $testsDir/Feature --configuration $configFile\n\n";
} else {
    echo "=== TESTES EM PARALELO ===\n";
    echo "Paratest nÃ£o instalado. Execute: composer require --dev brianium/paratest\n\n";
}

echo "âœ… Testes concluÃ­dos!\n";
